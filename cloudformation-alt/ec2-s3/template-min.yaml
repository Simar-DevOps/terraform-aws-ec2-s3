AWSTemplateFormatVersion: '2010-09-09'
Description: Minimal EC2 + SG (CloudFormation alt via OIDC)

Parameters:
  VpcId:        { Type: AWS::EC2::VPC::Id }
  SubnetId:     { Type: AWS::EC2::Subnet::Id }
  YourIpCidr:   { Type: String }
  InstanceType: { Type: String, Default: t3.micro }
  KeyName:      { Type: String, Default: '' }
  AmiId:        { Type: String }

Resources:
  WebSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH from your IP; HTTP/HTTPS open
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 22,  ToPort: 22,  CidrIp: !Ref YourIpCidr }
        - { IpProtocol: tcp, FromPort: 80,  ToPort: 80,  CidrIp: 0.0.0.0/0 }
        - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: 0.0.0.0/0 }
      SecurityGroupEgress:
        - { IpProtocol: -1, CidrIp: 0.0.0.0/0 }

  WebInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref AmiId
      InstanceType: !Ref InstanceType
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !Ref SubnetId
          GroupSet: [ !Ref WebSg ]
      KeyName: !If [HasKey, !Ref KeyName, !Ref "AWS::NoValue"]
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf -y install httpd
          systemctl enable --now httpd
          echo "Hello from CloudFormation (minimal)." > /var/www/html/index.html

Conditions:
  HasKey: !Not [ !Equals [ !Ref KeyName, "" ] ]

Outputs:
  InstanceId: { Value: !Ref WebInstance }
  PublicIp:   { Value: !GetAtt WebInstance.PublicIp }
